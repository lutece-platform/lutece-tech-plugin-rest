<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE document PUBLIC "//UNKNOWN/" "http://maven.apache.org/dtd/xdoc_1_0.dtd">
<document>
	<properties>
		<title>Lutèce - JCaptcha : Utilisation</title>
	</properties>
	<body>
		<section name="Utilisation">
		
				<p>
				Dans tous les cas d'intégration, il est nécessaire de déclarer les deux servlets employées par le plugin, dans le fichier web.xml de l'application.
				</p>
				<p>
					Déclaration des servlets :
				</p>
				<source>
&lt;servlet&gt;
	&lt;servlet-name&gt;JCaptchaImage&lt;/servlet-name&gt;
	&lt;servlet-class&gt;fr.paris.lutece.plugins.jcaptcha.service.image.ImageCaptchaServlet&lt;/servlet-class&gt;
&lt;/servlet&gt;
&lt;servlet&gt;
	&lt;servlet-name&gt;JCaptchaSound&lt;/servlet-name&gt;
	&lt;servlet-class&gt;fr.paris.lutece.plugins.jcaptcha.service.sound.SoundCaptchaServlet&lt;/servlet-class&gt;
&lt;/servlet&gt;
&lt;servlet-mapping&gt;
	&lt;servlet-name&gt;JCaptchaImage&lt;/servlet-name&gt;
	&lt;url-pattern&gt;/JCaptchaImage&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;
&lt;servlet-mapping&gt;
	&lt;servlet-name&gt;JCaptchaSound&lt;/servlet-name&gt;
	&lt;url-pattern&gt;/JCaptchaSound&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;
				</source>
			
			<p>
				Ensuite, plusieurs cas d'intégration sont possibles :
			</p>
		
			<subsection name="Intégration dans un module du plugin Formengine">
				<p>
					Description de la marche à suivre :
					<ul>
						<li>
							ajouter la dépendance sur le plugin JCaptcha dans le fichier pom.xml du module concerné (en remplaçant <em>current version</em> par la version souhaitée)
							<p>
								<source>
&lt;dependency&gt;
	&lt;groupId&gt;fr.paris.lutece.plugins&lt;/groupId&gt;
	&lt;artifactId&gt;plugin-jcaptcha&lt;/artifactId&gt;
	&lt;version&gt;<em>current version</em>&lt;/version&gt;
	&lt;type&gt;lutece-plugin&lt;/type&gt;
&lt;/dependency&gt;								
								</source>
							</p>
						</li>
						<li>modifier la classe du formulaire concerné (étendant la classe <code>SubForm</code>) afin de lui faire étendre  la classe <code>CaptchaSubForm</code></li>
					</ul>
				</p>
				<p>
					La dépendance peut être déclarée dans un projet de type site, afin de limiter le couplage entre un module du plugin Formengine et le plugin Jcaptcha. 
					De plus, cela permet de pouvoir activer simplement les captchas en fonction des sites.
				</p>
			</subsection>
			<subsection name="Intégration dans un plugin autre qu'un module du plugin Formengine">
				<p>
					Description de la marche à suivre :
					<ul>
						<li>
							ajouter la dépendance sur le plugin JCaptcha dans le fichier pom.xml du plugin concerné (en remplaçant <em>current version</em> par la version souhaitée)
							<p>
								<source>
&lt;dependency&gt;
	&lt;groupId&gt;fr.paris.lutece.plugins&lt;/groupId&gt;
	&lt;artifactId&gt;plugin-jcaptcha&lt;/artifactId&gt;
	&lt;version&gt;<em>current version</em>&lt;/version&gt;
	&lt;type&gt;lutece-plugin&lt;/type&gt;
&lt;/dependency&gt;								
								</source>
							</p>
						</li>
						<li>
						modifier la classe de la xpage du formulaire concerné (<code>&lt;non_du_plugin&gt;App.java</code>) qui étend la classe <code>XPageApplication</code> :<br/><br/>
						<ul>
							<li>
							<p>
							Ajouter un attribut privé <code>CaptchaSecurityService</code> à la classe, de la manière suivante :
							</p>
							<br/><br/>
							<p><code>private CaptchaSecurityService _captchaService = new CaptchaSecurityService( );</code></p>
							<br/><br/>
							</li>
							
							<li>
							<p>Ajouter la constante bookmark suivante :</p>
							<p><code>private static final String BOOKMARK_CAPTCHA  = "captcha";</code></p>
							</li>
							
							<li>
							<p>Dans la fonction qui renvoi le code html du Template ou doit être inséré votre captcha ajouté la ligne de code suivante :
							</p>
							<p><code>model.put( BOOKMARK_CAPTCHA, _captchaService.getHtmlCode() );</code></p>
							</li>
							<li>
							<p>Dans la fonction qui permet de valider votre formulaire rajouter la condition suivante :</p>
							<source>
if ( !_captchaService.validate( request ) )
{
	//Url de redirection si le code de sécurité n'est pas valide.
}
							</source>
							</li>
						</ul>
						</li>
						<li>
						<p>Modifier le Template dans le quel doit être inséré le captcha, en lui ajoutant le code suivant à l'endroit ou vous voulez l’intégrer :</p>
						<p><code>${captcha}</code></p>
						</li>
					</ul>
				</p>
			</subsection>
		</section>
	</body>
</document>